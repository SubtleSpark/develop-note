![[Excalidraw/JVM运行时数据区.excalidraw]]

JVM 运行时数据区包括：


- 与进程生命周期一致
    - 堆（Heap）
    - 方法区（Method Area）
    - 运行时常量池（Runtime Constant Pool）
- 与线程生命周期一致
    - JVM Stack
    - Native Method Stack
    - PC Register  


方法区：1.8之前是永久代，1.8之后是元空间。


非堆：方法区 + Code Cache


## PC 程序计数器
- 指示要运行的下一行代码的地址
- 线程私有，每个线程一个
- 执行到本地方法时，是 undefined


Q：为什么要PC？
A：为了在线程切换后，恢复到正确的执行位置

Q：为什么PC是线程私有的？
A：因为线程切换后，需要恢复到正确的执行位置。如果共享，那么线程切换后，就无法恢复到正确的执行位置。


## JVM Stack
JVM Stack 由栈帧组成，每个方法调用都会创建一个栈帧。
栈帧包含：
- 局部变量表
- 操作数栈
- 动态链接
- 方法返回地址
- 附加信息


### 局部变量表
- 由 Slot 组成
- 每个 Slot 可以存放一个 32 位以内的数据类型，64 位数据类型（如 long，double）占用两个 Slot，引用类型也占用一个 Slot
- 如果一个方法是实例方法，那么第 0 个 Slot 总用于存放 this 引用。因为实例方法需要 `this.func()` 这样的调用方式调用其他方法或访问属性
- 下面的图中起始程序计数器表示该变量作用域开始的地方，长度表示该变量作用域的长度。序号表示在 Slot 中的位置。
- 和 GC 有关。

![[attachments/Pasted image 20241205171248.png]]


### 操作数栈
